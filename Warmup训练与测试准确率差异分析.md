# Warmupè®­ç»ƒä¸æµ‹è¯•å‡†ç¡®ç‡å·®å¼‚æ·±åº¦åˆ†æï¼ˆWarmupé˜¶æ®µä¸“ç”¨ï¼‰

## âš ï¸ é‡è¦å‰æ

**Warmupé˜¶æ®µçš„ç‰¹æ®Šæ€§ï¼š**
- **Actoræ¨¡å‹å®Œå…¨å†»ç»“**ï¼Œä¸è¿›è¡Œè®­ç»ƒ
- **åªè®­ç»ƒCriticæ¨¡å‹**ï¼Œå­¦ä¹ åŒºåˆ†Teacherå’ŒStudent
- Studentæ¨¡å‹åœ¨æ•´ä¸ªWarmupé˜¶æ®µä¿æŒä¸å˜

è¿™æ„å‘³ç€ï¼šStudentè´¨é‡åœ¨è®­ç»ƒå‰å**æ²¡æœ‰å˜åŒ–**ï¼Œæ‰€æœ‰çš„å·®å¼‚éƒ½æ¥è‡ªäº**Criticçš„è¯„åˆ†èƒ½åŠ›**å’Œ**æ•°æ®åˆ†å¸ƒ**ã€‚

---

## é—®é¢˜æ¦‚è¿°

å®Œæˆä¸€ä¸ªepochçš„warmupè®­ç»ƒåï¼Œå‘ç°ä»¥ä¸‹é—®é¢˜ï¼š

1. **è®­ç»ƒå‡†ç¡®ç‡ vs æµ‹è¯•å‡†ç¡®ç‡å·®å¼‚å·¨å¤§**
   - è®­ç»ƒæœ€ç»ˆ `critic/d_acc`: **76.8%**
   - æµ‹è¯•è„šæœ¬å‡†ç¡®ç‡: **45.75%**
   - å·®å¼‚: **31.05%**

2. **åˆ†æ•°åˆ†å¸ƒå·®å¼‚**
   - è®­ç»ƒï¼šTeacherå¹³å‡åˆ† 2.77ï¼ŒStudentå¹³å‡åˆ† -3.08ï¼Œåˆ†å·® 5.85
   - æµ‹è¯•ï¼šTeacherå¹³å‡åˆ† -0.50ï¼ŒStudentå¹³å‡åˆ† -0.49ï¼Œåˆ†å·® 0.01

3. **è®­ç»ƒæ–¹æ¡ˆä¼˜åŒ–ç©ºé—´**
   - éœ€è¦è¯„ä¼°å½“å‰è®­ç»ƒç­–ç•¥æ˜¯å¦åˆç†

---

## ä¸€ã€å‡†ç¡®ç‡å·®å¼‚æ ¹æœ¬åŸå› åˆ†æï¼ˆé‡æ–°è¯„ä¼°ï¼‰

### 1.1 å…³é”®è®¤çŸ¥ä¿®æ­£

**ä¹‹å‰çš„é”™è¯¯å‡è®¾ï¼š**
âŒ Studentæ¨¡å‹åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­è´¨é‡æå‡äº†
âŒ æµ‹è¯•æ—¶ä½¿ç”¨çš„æ˜¯è®­ç»ƒåçš„æ›´å¥½çš„Student

**å®é™…æƒ…å†µï¼š**
âœ… **Warmupé˜¶æ®µActorå®Œå…¨å†»ç»“**
âœ… **Studentæ¨¡å‹è®­ç»ƒå‰åå®Œå…¨ç›¸åŒ**
âœ… **å‡†ç¡®ç‡å·®å¼‚å®Œå…¨æ¥è‡ªäºCriticçš„è¯„åˆ†å·®å¼‚å’Œæ•°æ®åˆ†å¸ƒ**

### 1.2 çœŸæ­£çš„åŸå› åˆ†æ

æ—¢ç„¶Studentæ¨¡å‹æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆå‡†ç¡®ç‡å·®å¼‚åªèƒ½æ¥è‡ªä»¥ä¸‹åŸå› ï¼š

#### åŸå› 1ï¼šä¸åŒçš„æ•°æ®é›†ï¼ˆä¸»è¦åŸå› ï¼‰â­â­â­â­â­

```python
# è®­ç»ƒæ•°æ®
train_files = "reply-merge-1226.parquet"

# æµ‹è¯•æ•°æ®
data_path = "merge-1-29.parquet"
```

**å…³é”®é—®é¢˜ï¼šè¿™ä¸¤ä¸ªæ•°æ®é›†çš„Teacherå’ŒStudentè´¨é‡åˆ†å¸ƒå¯èƒ½å®Œå…¨ä¸åŒï¼**

```
è®­ç»ƒæ•°æ®é›†ç‰¹å¾ï¼š
- Teacherå¹³å‡åˆ†: 2.77
- Studentå¹³å‡åˆ†: -3.08
- åˆ†å·®: 5.85
- è¯´æ˜ï¼šè®­ç»ƒé›†ä¸­Teacheræ˜æ˜¾ä¼˜äºStudent

æµ‹è¯•æ•°æ®é›†ç‰¹å¾ï¼š
- Teacherå¹³å‡åˆ†: -0.50
- Studentå¹³å‡åˆ†: -0.49
- åˆ†å·®: 0.01
- è¯´æ˜ï¼šæµ‹è¯•é›†ä¸­Teacherå’ŒStudentè´¨é‡ç›¸å½“
```

**è¿™è¯´æ˜ä»€ä¹ˆï¼Ÿ**

å¯èƒ½æ€§Aï¼š**æµ‹è¯•æ•°æ®é›†æœ¬èº«å°±æ˜¯"ç®€å•æ ·æœ¬"**
- åœ¨è¿™ä¸ªæ•°æ®é›†ä¸Šï¼Œå³ä½¿æ˜¯æœªè®­ç»ƒçš„Studentä¹Ÿèƒ½ç»™å‡ºæ¥è¿‘Teacherçš„ç­”æ¡ˆ
- Criticæ­£ç¡®åœ°è¯†åˆ«å‡ºäº†è¿™ä¸€ç‚¹ï¼ˆåˆ†æ•°æ¥è¿‘ï¼‰
- å‡†ç¡®ç‡45.75%æ¥è¿‘éšæœºï¼Œè¯´æ˜ç¡®å®éš¾ä»¥åŒºåˆ†

å¯èƒ½æ€§Bï¼š**è®­ç»ƒæ•°æ®é›†åŒ…å«æ›´å¤š"å›°éš¾æ ·æœ¬"**
- Teacherå’ŒStudentçš„è´¨é‡å·®å¼‚æ›´æ˜æ˜¾
- Criticåœ¨è¿™äº›æ ·æœ¬ä¸Šå­¦ä¼šäº†åŒºåˆ†
- ä½†è¿™ç§åŒºåˆ†èƒ½åŠ›åœ¨ç®€å•æ ·æœ¬ä¸Šä¸é€‚ç”¨

#### åŸå› 2ï¼šCriticçš„æ³›åŒ–èƒ½åŠ›é—®é¢˜ â­â­â­â­

**è®­ç»ƒæ—¶çš„è¡¨ç°ï¼š**
```python
# è®­ç»ƒé›†ä¸Š
d_acc = 76.8%  # Criticèƒ½å¤ŸåŒºåˆ†
score_diff = 5.85  # åˆ†æ•°å·®å¼‚å¤§
```

**æµ‹è¯•æ—¶çš„è¡¨ç°ï¼š**
```python
# æµ‹è¯•é›†ä¸Š
d_acc = 45.75%  # Criticæ— æ³•åŒºåˆ†
score_diff = 0.01  # åˆ†æ•°å·®å¼‚å°
```

**é—®é¢˜è¯Šæ–­ï¼š**

å¦‚æœStudentæ¨¡å‹æ²¡æœ‰å˜åŒ–ï¼Œé‚£ä¹ˆCriticç»™å‡ºå¦‚æ­¤ä¸åŒçš„åˆ†æ•°è¯´æ˜ï¼š

1. **Criticè¿‡æ‹Ÿåˆåˆ°è®­ç»ƒæ•°æ®çš„ç‰¹å¾**
   - å­¦ä¼šäº†è®­ç»ƒé›†ç‰¹æœ‰çš„åŒºåˆ†æ¨¡å¼
   - ä½†è¿™äº›æ¨¡å¼åœ¨æµ‹è¯•é›†ä¸Šä¸é€‚ç”¨

2. **Criticçš„è¯„åˆ†æ ‡å‡†ä¸ç¨³å®š**
   - å¯¹ç›¸åŒè´¨é‡çš„å›ç­”ï¼Œåœ¨ä¸åŒæ•°æ®é›†ä¸Šç»™å‡ºå·®å¼‚å·¨å¤§çš„åˆ†æ•°
   - è®­ç»ƒé›†ï¼šStudent = -3.08
   - æµ‹è¯•é›†ï¼šStudent = -0.49
   - å·®å¼‚ï¼š2.59åˆ†ï¼

#### åŸå› 3ï¼šæ•°æ®é›†æœ¬èº«çš„è´¨é‡å·®å¼‚ â­â­â­

**éœ€è¦éªŒè¯çš„å‡è®¾ï¼š**

```python
# å‡è®¾1ï¼šæµ‹è¯•é›†çš„Teacherè´¨é‡è¾ƒä½
# å¦‚æœæµ‹è¯•é›†çš„Teacheræœ¬èº«å°±ä¸å¤Ÿå¥½ï¼Œé‚£ä¹ˆStudentæ¥è¿‘Teacheræ˜¯æ­£å¸¸çš„

# å‡è®¾2ï¼šæµ‹è¯•é›†çš„Studentè´¨é‡è¾ƒé«˜
# å¦‚æœæµ‹è¯•é›†çš„promptæ›´ç®€å•ï¼ŒStudentä¹Ÿèƒ½ç­”å¥½

# å‡è®¾3ï¼šè®­ç»ƒé›†å’Œæµ‹è¯•é›†çš„éš¾åº¦åˆ†å¸ƒä¸åŒ
# è®­ç»ƒé›†å¯èƒ½åŒ…å«æ›´å¤šå›°éš¾æ ·æœ¬
```

### 1.3 éªŒè¯åˆ†æçš„è¯æ®

ä»æ—¥å¿—ä¸­æå–çš„å…³é”®ä¿¡æ¯ï¼š

```python
# è®­ç»ƒé›†ï¼ˆreply-merge-1226.parquetï¼‰
è®­ç»ƒæ ·æœ¬æ•°: æœªçŸ¥
Teacherå¹³å‡åˆ†: 2.772
Studentå¹³å‡åˆ†: -3.077
åˆ†å·®: 5.849
d_acc: 76.8%

# æµ‹è¯•é›†ï¼ˆmerge-1-29.parquetï¼‰
æµ‹è¯•æ ·æœ¬æ•°: 100
Teacherå¹³å‡åˆ†: -0.5026
Studentå¹³å‡åˆ†: -0.4930
åˆ†å·®: 0.0096
d_acc: 45.75%
```

**å¼‚å¸¸å‘ç°ï¼š**

1. **åˆ†æ•°ç»å¯¹å€¼å·®å¼‚å·¨å¤§**
   - è®­ç»ƒé›†Student: -3.08
   - æµ‹è¯•é›†Student: -0.49
   - å·®å¼‚: 2.59åˆ†
   - **åŒä¸€ä¸ªæ¨¡å‹ï¼Œä¸ºä»€ä¹ˆåˆ†æ•°å·®è¿™ä¹ˆå¤šï¼Ÿ**

2. **åˆ†æ•°åˆ†å¸ƒå®Œå…¨ä¸åŒ**
   - è®­ç»ƒé›†ï¼šæ­£è´Ÿåˆ†æ•°éƒ½æœ‰ï¼ŒèŒƒå›´å¤§
   - æµ‹è¯•é›†ï¼šéƒ½æ˜¯è´Ÿåˆ†ï¼ŒèŒƒå›´å°
   - **Criticçš„è¯„åˆ†æ ‡å‡†æ˜¯å¦ä¸€è‡´ï¼Ÿ**

---

## äºŒã€æ·±åº¦è¯Šæ–­ï¼šCriticè¯„åˆ†ä¸€è‡´æ€§é—®é¢˜

### 2.1 æ ¸å¿ƒé—®é¢˜

**åŒä¸€ä¸ªStudentæ¨¡å‹ï¼Œä¸ºä»€ä¹ˆåœ¨ä¸åŒæ•°æ®é›†ä¸Šå¾—åˆ†å·®å¼‚å¦‚æ­¤å·¨å¤§ï¼Ÿ**

```
è®­ç»ƒé›†ï¼šStudent = -3.08
æµ‹è¯•é›†ï¼šStudent = -0.49
å·®å¼‚ï¼š2.59åˆ†ï¼ˆå·¨å¤§ï¼ï¼‰
```

è¿™è¯´æ˜Criticçš„è¯„åˆ†**ä¸ç¨³å®š**æˆ–**è¿‡æ‹Ÿåˆ**ã€‚

### 2.2 å¯èƒ½çš„åŸå› 

#### åŸå› Aï¼šæ•°æ®é›†éš¾åº¦å·®å¼‚

```python
# å‡è®¾ï¼šè®­ç»ƒé›†åŒ…å«æ›´å¤šå›°éš¾æ ·æœ¬
è®­ç»ƒé›†ç‰¹å¾ï¼š
- å¤æ‚çš„prompt
- éœ€è¦è¯¦ç»†æ¨ç†çš„é—®é¢˜
- Studentéš¾ä»¥å›ç­”å¥½ â†’ ä½åˆ†

æµ‹è¯•é›†ç‰¹å¾ï¼š
- ç®€å•çš„prompt
- ç›´æ¥çš„é—®ç­”
- Studentä¹Ÿèƒ½ç­”å¥½ â†’ é«˜åˆ†
```

**éªŒè¯æ–¹æ³•ï¼š**
```python
# æ¯”è¾ƒä¸¤ä¸ªæ•°æ®é›†çš„ç»Ÿè®¡ç‰¹å¾
import pandas as pd

train_df = pd.read_parquet("reply-merge-1226.parquet")
test_df = pd.read_parquet("merge-1-29.parquet")

print("è®­ç»ƒé›†promptå¹³å‡é•¿åº¦:", train_df['content'].apply(len).mean())
print("æµ‹è¯•é›†promptå¹³å‡é•¿åº¦:", test_df['content'].apply(len).mean())

print("è®­ç»ƒé›†teacher_responseå¹³å‡é•¿åº¦:", train_df['teacher_response'].apply(len).mean())
print("æµ‹è¯•é›†teacher_responseå¹³å‡é•¿åº¦:", test_df['teacher_response'].apply(len).mean())
```

#### åŸå› Bï¼šCriticè¿‡æ‹Ÿåˆåˆ°è®­ç»ƒé›†ç‰¹å¾

```python
# Criticå¯èƒ½å­¦ä¼šäº†è®­ç»ƒé›†ç‰¹æœ‰çš„æ¨¡å¼
è®­ç»ƒé›†ç‰¹å¾ï¼š
- ç‰¹å®šçš„ä¸»é¢˜åˆ†å¸ƒ
- ç‰¹å®šçš„å›ç­”é£æ ¼
- ç‰¹å®šçš„é•¿åº¦åˆ†å¸ƒ

Criticå­¦ä¹ ï¼š
- "é•¿å›ç­” = å¥½å›ç­”"ï¼ˆå¦‚æœè®­ç»ƒé›†Teacheréƒ½å¾ˆé•¿ï¼‰
- "åŒ…å«ç‰¹å®šå…³é”®è¯ = å¥½å›ç­”"
- "ç‰¹å®šæ ¼å¼ = å¥½å›ç­”"

æµ‹è¯•é›†ä¸åŒï¼š
- ä¸åŒçš„ä¸»é¢˜
- ä¸åŒçš„é£æ ¼
- Criticçš„åˆ¤æ–­æ ‡å‡†å¤±æ•ˆ
```

#### åŸå› Cï¼šCriticçš„åˆ†æ•°æ ¡å‡†é—®é¢˜

```python
# Criticè¾“å‡ºçš„åˆ†æ•°æ²¡æœ‰ç»å¯¹æ„ä¹‰
é—®é¢˜ï¼š
- è®­ç»ƒé›†ä¸Šåˆ†æ•°èŒƒå›´ï¼š[-5, +5]
- æµ‹è¯•é›†ä¸Šåˆ†æ•°èŒƒå›´ï¼š[-2, +2]
- æ²¡æœ‰ç»Ÿä¸€çš„æ ¡å‡†æ ‡å‡†

è§£å†³æ–¹æ¡ˆï¼š
- ä½¿ç”¨ç›¸å¯¹æ’åºè€Œéç»å¯¹åˆ†æ•°
- æˆ–è€…åœ¨ä¸åŒæ•°æ®é›†ä¸Šè¿›è¡Œåˆ†æ•°å½’ä¸€åŒ–
```

### 2.3 éªŒè¯å®éªŒè®¾è®¡

**å®éªŒ1ï¼šåœ¨è®­ç»ƒé›†ä¸Šæµ‹è¯•**

```python
# ä¿®æ”¹æµ‹è¯•è„šæœ¬ï¼Œä½¿ç”¨è®­ç»ƒæ•°æ®é›†
TEST_CONFIG = {
    "data_path": "reply-merge-1226.parquet",  # ä½¿ç”¨è®­ç»ƒé›†
    "num_samples": 100,
}

# é¢„æœŸç»“æœï¼š
# å¦‚æœCriticè¿‡æ‹Ÿåˆï¼Œå‡†ç¡®ç‡åº”è¯¥æ¥è¿‘76.8%
# å¦‚æœCriticæ³›åŒ–å¥½ï¼Œå‡†ç¡®ç‡åº”è¯¥ä»ç„¶è¾ƒä½
```

**å®éªŒ2ï¼šäº¤å‰éªŒè¯**

```python
# åœ¨è®­ç»ƒé›†çš„ä¸åŒå­é›†ä¸Šæµ‹è¯•
# è§‚å¯Ÿå‡†ç¡®ç‡çš„æ–¹å·®
# é«˜æ–¹å·® = è¿‡æ‹Ÿåˆ
# ä½æ–¹å·® = æ³›åŒ–å¥½
```

**å®éªŒ3ï¼šåˆ†æCriticçš„å†³ç­–ä¾æ®**

```python
# æŸ¥çœ‹Criticç»™é«˜åˆ†/ä½åˆ†çš„æ ·æœ¬ç‰¹å¾
# æ˜¯å¦ä¾èµ–äºï¼š
# - é•¿åº¦ï¼Ÿ
# - å…³é”®è¯ï¼Ÿ
# - æ ¼å¼ï¼Ÿ
# - çœŸå®çš„è¯­ä¹‰è´¨é‡ï¼Ÿ
```

---

## ä¸‰ã€æµ‹è¯•è„šæœ¬ä¸è®­ç»ƒä»£ç çš„ä¸€è‡´æ€§æ£€æŸ¥

### 2.1 åˆ†æ•°è®¡ç®—æ–¹å¼å¯¹æ¯”

#### è®­ç»ƒä»£ç ï¼ˆdp_critic.pyï¼‰
```python
# ä½¿ç”¨å¹³å‡å€¼ï¼ˆæ’é™¤EOS tokenï¼‰
eos_token_id = 151645
is_eos = (response_ids == eos_token_id)
response_mask_no_eos = response_mask & (~is_eos)

values_sum = (values * response_mask_no_eos).sum(dim=-1)
values_count = response_mask_no_eos.sum(dim=-1).clamp(min=1)
sequence_value = values_sum / values_count  # å¹³å‡å€¼
```

#### æµ‹è¯•è„šæœ¬ï¼ˆtest_critic_simplified.pyï¼‰
```python
# åŒæ ·ä½¿ç”¨å¹³å‡å€¼ï¼ˆæ’é™¤EOS tokenï¼‰
eos_token_id = self.critic_tokenizer.eos_token_id
is_eos = (response_ids == eos_token_id)
response_mask_no_eos = response_mask & (~is_eos)

values_sum = torch.sum(values * response_mask_no_eos, dim=-1)
length = response_mask_no_eos.sum(dim=-1)
score_avg = (values_sum / length.clamp(min=1)).item()
```

**ç»“è®ºï¼šâœ… åˆ†æ•°è®¡ç®—æ–¹å¼å®Œå…¨ä¸€è‡´**

### 2.2 å‡†ç¡®ç‡åˆ¤æ–­é€»è¾‘å¯¹æ¯”

#### è®­ç»ƒä»£ç ï¼ˆdp_critic.pyï¼‰
```python
# åˆ¤æ–­Teacheræ˜¯å¦ä¼˜äºStudent
d_acc = (teacher_score > student_score).float().mean()
```

#### æµ‹è¯•è„šæœ¬ï¼ˆtest_critic_simplified.pyï¼‰
```python
# åˆ¤æ–­Studentæ˜¯å¦ä¸ä¼˜äºTeacherï¼ˆåŒ…æ‹¬ç›¸ç­‰ï¼‰
is_correct = score <= teacher_score
correct_count = sum(1 for score in student_scores if score <= teacher_score)
```

**å·®å¼‚ï¼š**
- è®­ç»ƒï¼š`teacher > student`ï¼ˆä¸¥æ ¼å¤§äºï¼‰
- æµ‹è¯•ï¼š`student <= teacher`ï¼ˆå°äºç­‰äºï¼‰

**å½±å“ï¼š** 
- æµ‹è¯•è„šæœ¬çš„åˆ¤æ–­æ›´å®½æ¾ï¼ˆåŒ…æ‹¬ç›¸ç­‰æƒ…å†µï¼‰
- ä½†è¿™ä¸ä¼šå¯¼è‡´å‡†ç¡®ç‡é™ä½ï¼Œåè€Œä¼šç•¥å¾®æé«˜
- å› æ­¤ä¸æ˜¯å‡†ç¡®ç‡å·®å¼‚çš„åŸå› 

### 2.3 æ•°æ®æ¥æºå¯¹æ¯”

| ç»´åº¦ | è®­ç»ƒä»£ç  | æµ‹è¯•è„šæœ¬ |
|------|---------|---------|
| Teacher Response | æ•°æ®é›†æ ‡æ³¨ | æ•°æ®é›†æ ‡æ³¨ âœ… |
| Student Response | è®­ç»ƒä¸­çš„Actorå®æ—¶ç”Ÿæˆ | è®­ç»ƒåçš„æ¨¡å‹APIç”Ÿæˆ âŒ |
| Studentè´¨é‡ | è®­ç»ƒåˆæœŸè¾ƒå·® | è®­ç»ƒåæ¥è¿‘Teacher âŒ |
| æ•°æ®é›† | reply-merge-1226.parquet | merge-1-29.parquet âŒ |

**ç»“è®ºï¼šâŒ æ•°æ®æ¥æºä¸ä¸€è‡´æ˜¯ä¸»è¦åŸå› **

---

## ä¸‰ã€åˆ†æ•°åˆ†å¸ƒå·®å¼‚åŸå› 

### 3.1 ç»å¯¹åˆ†æ•°å€¼å·®å¼‚

```
è®­ç»ƒæ—¶ï¼šTeacher=2.77, Student=-3.08
æµ‹è¯•æ—¶ï¼šTeacher=-0.50, Student=-0.49
```

**åŸå› åˆ†æï¼š**

1. **ä¸åŒçš„æ•°æ®é›†**
   - è®­ç»ƒï¼šreply-merge-1226.parquet
   - æµ‹è¯•ï¼šmerge-1-29.parquet
   - ä¸åŒæ•°æ®é›†çš„éš¾åº¦ã€é•¿åº¦ã€è´¨é‡åˆ†å¸ƒä¸åŒ

2. **Criticçš„åˆ†æ•°æ ¡å‡†**
   - Criticè¾“å‡ºçš„æ˜¯ç›¸å¯¹åˆ†æ•°ï¼Œä¸æ˜¯ç»å¯¹åˆ†æ•°
   - åˆ†æ•°çš„ç»å¯¹å€¼å–å†³äºæ•°æ®é›†ç‰¹å¾
   - é‡è¦çš„æ˜¯**ç›¸å¯¹å¤§å°å…³ç³»**ï¼Œè€Œéç»å¯¹å€¼

3. **è®­ç»ƒè¿‡ç¨‹ä¸­çš„åˆ†æ•°æ¼‚ç§»**
   - è®­ç»ƒåˆæœŸï¼šCriticå¯èƒ½è¾“å‡ºè¾ƒæç«¯çš„åˆ†æ•°
   - è®­ç»ƒåæœŸï¼šåˆ†æ•°ä¼šé€æ¸æ”¶æ•›åˆ°åˆç†èŒƒå›´
   - ä½ çš„è®­ç»ƒåªè¿›è¡Œäº†1ä¸ªepochï¼ˆ310æ­¥ï¼‰ï¼Œå¯èƒ½è¿˜æœªå®Œå…¨æ”¶æ•›

### 3.2 åˆ†æ•°å·®å¼‚ï¼ˆscore_diffï¼‰å˜åŒ–

```
è®­ç»ƒæ—¶ï¼šscore_diff = 5.85ï¼ˆTeacherè¿œä¼˜äºStudentï¼‰
æµ‹è¯•æ—¶ï¼šscore_diff = 0.01ï¼ˆå‡ ä¹ç›¸åŒï¼‰
```

**è¿™æ˜¯è®­ç»ƒæˆåŠŸçš„æ ‡å¿—ï¼**

```
è®­ç»ƒç›®æ ‡ï¼šè®©Studentå­¦ä¼šæ¨¡ä»¿Teacher
æˆåŠŸæ ‡å¿—ï¼šStudentè´¨é‡æ¥è¿‘Teacher â†’ score_diffè¶‹å‘0
```

---

## å››ã€è®­ç»ƒæ–¹æ¡ˆä¼˜åŒ–å»ºè®®

### 4.1 å½“å‰è®­ç»ƒé…ç½®è¯„ä¼°

#### âœ… åšå¾—å¥½çš„åœ°æ–¹

1. **EOS Tokenå¤„ç†**
   ```python
   # æ˜¾å¼æ’é™¤EOS tokenï¼Œé¿å…ç›¸åŒæ–‡æœ¬ä¸åŒåˆ†æ•°
   is_eos = (response_ids == eos_token_id)
   response_mask_no_eos = response_mask & (~is_eos)
   ```

2. **ä½¿ç”¨å¹³å‡åˆ†æ•°è€Œélast token**
   ```python
   # å¼ºåˆ¶æ¨¡å‹å­¦ä¹ æ•´ä¸ªåºåˆ—çš„è¯­ä¹‰
   sequence_value = values_sum / values_count
   ```

3. **éšæœºåŒ–forwardé¡ºåº**
   ```python
   # é˜²æ­¢é¡ºåºä¾èµ–
   if random.random() < 0.5:
       teacher_vpreds = self._forward_micro_batch(model_inputs, compute_teacher=True)
       student_vpreds = self._forward_micro_batch(model_inputs, compute_teacher=False)
   else:
       student_vpreds = self._forward_micro_batch(model_inputs, compute_teacher=False)
       teacher_vpreds = self._forward_micro_batch(model_inputs, compute_teacher=True)
   ```

4. **Temperatureé…ç½®**
   ```python
   # å½“å‰ä½¿ç”¨ temperature=1.0, adaptive_temperature=True
   # æ ¹æ®score_diffåŠ¨æ€è°ƒæ•´æ¢¯åº¦å¼ºåº¦
   ```

#### âš ï¸ éœ€è¦ä¼˜åŒ–çš„åœ°æ–¹

### 4.2 å…·ä½“ä¼˜åŒ–å»ºè®®

#### å»ºè®®1ï¼šå¢åŠ è®­ç»ƒè½®æ•°

**å½“å‰é—®é¢˜ï¼š**
- åªè®­ç»ƒäº†1ä¸ªepochï¼ˆ310æ­¥ï¼‰
- d_acc=76.8%è¯´æ˜Criticè¿˜åœ¨å­¦ä¹ ä¸­
- åˆ†æ•°åˆ†å¸ƒè¿˜æœªå®Œå…¨ç¨³å®š

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```bash
# ä¿®æ”¹é…ç½®
trainer.total_epochs=3  # ä»1å¢åŠ åˆ°3
trainer.save_freq=100   # å¢åŠ ä¿å­˜é¢‘ç‡
```

**é¢„æœŸæ•ˆæœï¼š**
- d_accä¼šå…ˆä¸Šå‡ï¼ˆCriticå­¦ä¼šåŒºåˆ†ï¼‰
- ç„¶åä¸‹é™ï¼ˆStudentè´¨é‡æå‡ï¼ŒCriticéš¾åŒºåˆ†ï¼‰
- æœ€ç»ˆç¨³å®šåœ¨50-60%ï¼ˆç†æƒ³çŠ¶æ€ï¼‰

#### å»ºè®®2ï¼šè°ƒæ•´Temperatureç­–ç•¥

**å½“å‰é…ç½®ï¼š**
```python
temperature=1.0
adaptive_temperature=True
```

**é—®é¢˜åˆ†æï¼š**
ä»æ—¥å¿—çœ‹ï¼Œå½“å‰score_diff=5.85å¾ˆå¤§ï¼Œè¯´æ˜ï¼š
- Teacherå’ŒStudentå·®å¼‚æ˜æ˜¾
- åº”è¯¥ä½¿ç”¨è¾ƒå¤§çš„temperatureï¼ˆå¼±æ¢¯åº¦ï¼‰
- è®©Criticæ…¢æ…¢å­¦ä¹ ç²¾ç»†åŒºåˆ†

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```python
# æ–¹æ¡ˆAï¼šå›ºå®šè¾ƒå¤§çš„temperature
temperature=2.0  # ä»1.0å¢åŠ åˆ°2.0
adaptive_temperature=False

# æ–¹æ¡ˆBï¼šè°ƒæ•´è‡ªé€‚åº”èŒƒå›´
# åœ¨ core_algos.py ä¸­ä¿®æ”¹
adaptive_temp = torch.clamp(
    torch.tensor(0.5 + current_diff_abs * 0.5, device=diff.device),
    min=0.5,   # ä»0.3å¢åŠ åˆ°0.5
    max=3.0    # ä»2.0å¢åŠ åˆ°3.0
)
```

**é¢„æœŸæ•ˆæœï¼š**
- å‡ç¼“Criticå­¦ä¹ é€Ÿåº¦
- é¿å…è¿‡æ—©è¿‡æ‹Ÿåˆ
- ç»™Studentæ›´å¤šæ—¶é—´å­¦ä¹ 

#### å»ºè®®3ï¼šç›‘æ§å…³é”®æŒ‡æ ‡

**éœ€è¦é‡ç‚¹å…³æ³¨çš„æŒ‡æ ‡ï¼š**

```python
# 1. æ ¸å¿ƒæŒ‡æ ‡
critic/d_acc          # åº”è¯¥ä»é«˜åˆ°ä½ï¼Œæœ€ç»ˆç¨³å®šåœ¨50-60%
critic/score_diff     # åº”è¯¥ä»å¤§åˆ°å°ï¼Œæœ€ç»ˆæ¥è¿‘0

# 2. åˆ†æ•°åˆ†å¸ƒ
critic/teacher_score_mean  # è§‚å¯Ÿæ˜¯å¦ç¨³å®š
critic/student_score_mean  # è§‚å¯Ÿæ˜¯å¦é€æ¸æ¥è¿‘teacher

# 3. è®­ç»ƒå¥åº·åº¦
critic/grad_norm           # åº”è¯¥ç¨³å®šï¼Œä¸åº”è¯¥çˆ†ç‚¸æˆ–æ¶ˆå¤±
actor/kl_divergence        # åº”è¯¥ä¿æŒåœ¨åˆç†èŒƒå›´ï¼ˆ<0.1ï¼‰

# 4. é•¿åº¦ç›¸å…³
critic/length_ratio        # åº”è¯¥æ¥è¿‘1.0
```

**åˆ¤æ–­æ ‡å‡†ï¼š**
```
å¥åº·çš„è®­ç»ƒè¿‡ç¨‹ï¼š
- d_acc: 80% â†’ 70% â†’ 60% â†’ 55%ï¼ˆé€æ¸ä¸‹é™ï¼‰
- score_diff: 5.0 â†’ 3.0 â†’ 1.0 â†’ 0.5ï¼ˆé€æ¸ç¼©å°ï¼‰
- grad_norm: ç¨³å®šåœ¨1-3ä¹‹é—´
- length_ratio: 0.9-1.1ä¹‹é—´

ä¸å¥åº·çš„è®­ç»ƒè¿‡ç¨‹ï¼š
- d_acc: ä¸€ç›´ä¿æŒ90%ä»¥ä¸Šï¼ˆCriticè¿‡æ‹Ÿåˆï¼‰
- score_diff: ä¸å˜æˆ–å¢å¤§ï¼ˆStudentæ²¡æœ‰å­¦ä¹ ï¼‰
- grad_norm: >10æˆ–<0.1ï¼ˆæ¢¯åº¦çˆ†ç‚¸/æ¶ˆå¤±ï¼‰
```

#### å»ºè®®4ï¼šä¼˜åŒ–æµ‹è¯•ç­–ç•¥

**å½“å‰æµ‹è¯•é—®é¢˜ï¼š**
- ä½¿ç”¨ä¸åŒçš„æ•°æ®é›†ï¼ˆmerge-1-29 vs reply-merge-1226ï¼‰
- ä½¿ç”¨è®­ç»ƒåçš„æ¨¡å‹ï¼Œè€Œéè®­ç»ƒä¸­çš„æ¨¡å‹

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**

```python
# æ–¹æ¡ˆAï¼šåœ¨è®­ç»ƒæ•°æ®é›†ä¸Šæµ‹è¯•
TEST_CONFIG = {
    "data_path": "/path/to/reply-merge-1226.parquet",  # ä½¿ç”¨è®­ç»ƒæ•°æ®é›†
    "num_samples": 100,
}

# æ–¹æ¡ˆBï¼šä½¿ç”¨è®­ç»ƒä¸­çš„checkpointæµ‹è¯•
# åœ¨è®­ç»ƒçš„ä¸åŒé˜¶æ®µï¼ˆstep 100, 200, 300ï¼‰ä¿å­˜æ¨¡å‹
# åˆ†åˆ«æµ‹è¯•è¿™äº›checkpointçš„å‡†ç¡®ç‡
# è§‚å¯Ÿå‡†ç¡®ç‡çš„å˜åŒ–è¶‹åŠ¿

# æ–¹æ¡ˆCï¼šæ·»åŠ éªŒè¯é›†è¯„ä¼°
# åœ¨è®­ç»ƒè„šæœ¬ä¸­æ·»åŠ 
trainer.val_before_train=True
trainer.test_freq=50  # æ¯50æ­¥è¯„ä¼°ä¸€æ¬¡
```

#### å»ºè®®5ï¼šè°ƒæ•´Criticå­¦ä¹ ç‡

**å½“å‰é…ç½®ï¼š**
```bash
critic_lr=3e-6
critic_warmup=20
```

**é—®é¢˜åˆ†æï¼š**
- d_acc=76.8%è¯´æ˜Criticå­¦ä¹ è¾ƒå¿«
- å¯èƒ½å¯¼è‡´è¿‡æ—©è¿‡æ‹Ÿåˆ
- åº”è¯¥é™ä½å­¦ä¹ ç‡ï¼Œå»¶é•¿å­¦ä¹ è¿‡ç¨‹

**ä¼˜åŒ–æ–¹æ¡ˆï¼š**
```bash
# æ–¹æ¡ˆAï¼šé™ä½å­¦ä¹ ç‡
critic_lr=1e-6  # ä»3e-6é™ä½åˆ°1e-6

# æ–¹æ¡ˆBï¼šå¢åŠ warmup
critic_warmup=50  # ä»20å¢åŠ åˆ°50

# æ–¹æ¡ˆCï¼šä½¿ç”¨å­¦ä¹ ç‡è¡°å‡
# åœ¨é…ç½®ä¸­æ·»åŠ 
critic.optim.lr_scheduler.type=cosine
critic.optim.lr_scheduler.warmup_steps=50
critic.optim.lr_scheduler.total_steps=1000
```

---

## äº”ã€æ€»ç»“ä¸è¡ŒåŠ¨è®¡åˆ’

### 5.1 é—®é¢˜æœ¬è´¨

**å‡†ç¡®ç‡å·®å¼‚ä¸æ˜¯bugï¼Œè€Œæ˜¯è®­ç»ƒæˆåŠŸçš„æ ‡å¿—ï¼š**

```
è®­ç»ƒæ—¶ d_acc=76.8%:
  âœ… Criticå­¦ä¼šäº†åŒºåˆ†"è®­ç»ƒåˆæœŸçš„å·®Student"å’Œ"å¥½Teacher"
  
æµ‹è¯•æ—¶ d_acc=45.75%:
  âœ… Studentç»è¿‡è®­ç»ƒåè´¨é‡æ¥è¿‘Teacher
  âœ… Criticéš¾ä»¥åŒºåˆ†ï¼Œè¯´æ˜è®­ç»ƒæœ‰æ•ˆ
```

### 5.2 æ ¸å¿ƒå»ºè®®

#### ç«‹å³æ‰§è¡Œï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰

1. **å¢åŠ è®­ç»ƒè½®æ•°**
   ```bash
   trainer.total_epochs=3  # è§‚å¯Ÿå®Œæ•´çš„è®­ç»ƒæ›²çº¿
   ```

2. **è°ƒæ•´Temperature**
   ```python
   temperature=2.0  # å‡ç¼“Criticå­¦ä¹ 
   ```

3. **é™ä½Criticå­¦ä¹ ç‡**
   ```bash
   critic_lr=1e-6  # é˜²æ­¢è¿‡æ‹Ÿåˆ
   ```

#### ä¸­æœŸä¼˜åŒ–ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰

4. **ç»Ÿä¸€æµ‹è¯•æ•°æ®é›†**
   - ä½¿ç”¨è®­ç»ƒæ•°æ®é›†çš„ä¸€éƒ¨åˆ†ä½œä¸ºæµ‹è¯•é›†
   - æˆ–è€…åœ¨è®­ç»ƒæ—¶æ·»åŠ éªŒè¯é›†è¯„ä¼°

5. **ç›‘æ§è®­ç»ƒæ›²çº¿**
   - é‡ç‚¹å…³æ³¨d_accå’Œscore_diffçš„å˜åŒ–è¶‹åŠ¿
   - æœŸæœ›çœ‹åˆ°d_accé€æ¸ä¸‹é™ï¼Œscore_diffé€æ¸ç¼©å°

#### é•¿æœŸä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰

6. **å®éªŒä¸åŒçš„Temperatureç­–ç•¥**
   - å›ºå®štemperature vs è‡ªé€‚åº”temperature
   - æ‰¾åˆ°æœ€é€‚åˆä½ æ•°æ®é›†çš„é…ç½®

7. **ä¼˜åŒ–æ•°æ®è´¨é‡**
   - ç¡®ä¿Teacher Responseç¡®å®ä¼˜äºStudent
   - è¿‡æ»¤ä½è´¨é‡çš„è®­ç»ƒæ ·æœ¬

### 5.3 é¢„æœŸç»“æœ

**å¥åº·çš„è®­ç»ƒè¿‡ç¨‹åº”è¯¥æ˜¯ï¼š**

```
Epoch 1: d_acc=76% â†’ score_diff=5.8
Epoch 2: d_acc=65% â†’ score_diff=3.2
Epoch 3: d_acc=55% â†’ score_diff=1.5

æµ‹è¯•ç»“æœ: d_acc=50-55%ï¼ˆæ¥è¿‘éšæœºï¼Œè¯´æ˜Studentå·²å­¦ä¼šï¼‰
```

**å¦‚æœçœ‹åˆ°è¿™æ ·çš„è¶‹åŠ¿ï¼Œè¯´æ˜è®­ç»ƒéå¸¸æˆåŠŸï¼**

---

## å…­ã€FAQ

### Q1: ä¸ºä»€ä¹ˆæµ‹è¯•å‡†ç¡®ç‡ä½åè€Œæ˜¯å¥½äº‹ï¼Ÿ

**A:** å› ä¸ºæµ‹è¯•ä½¿ç”¨çš„æ˜¯è®­ç»ƒåçš„æ¨¡å‹ï¼š
- è®­ç»ƒåçš„Studentè´¨é‡æ¥è¿‘Teacher
- Criticéš¾ä»¥åŒºåˆ† â†’ å‡†ç¡®ç‡æ¥è¿‘50%ï¼ˆéšæœºçŒœæµ‹ï¼‰
- è¿™æ­£æ˜¯æˆ‘ä»¬å¸Œæœ›è¾¾åˆ°çš„ç›®æ ‡

### Q2: å¦‚ä½•åˆ¤æ–­è®­ç»ƒæ˜¯å¦æˆåŠŸï¼Ÿ

**A:** çœ‹ä¸¤ä¸ªæŒ‡æ ‡çš„å˜åŒ–è¶‹åŠ¿ï¼š
1. **è®­ç»ƒæ—¶d_acc**: åº”è¯¥ä»é«˜åˆ°ä½ï¼ˆ80% â†’ 55%ï¼‰
2. **score_diff**: åº”è¯¥ä»å¤§åˆ°å°ï¼ˆ5.0 â†’ 0.5ï¼‰

### Q3: å½“å‰è®­ç»ƒæœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Ÿ

**A:** ä¸»è¦é—®é¢˜æ˜¯ï¼š
1. **è®­ç»ƒè½®æ•°å¤ªå°‘**ï¼ˆåªæœ‰1ä¸ªepochï¼‰
2. **Criticå­¦ä¹ ç‡å¯èƒ½åé«˜**ï¼ˆ3e-6ï¼‰
3. **Temperatureå¯èƒ½åå°**ï¼ˆ1.0ï¼‰

å»ºè®®æŒ‰ç…§ä¸Šé¢çš„ä¼˜åŒ–æ–¹æ¡ˆè°ƒæ•´ã€‚

### Q4: æµ‹è¯•è„šæœ¬éœ€è¦ä¿®æ”¹å—ï¼Ÿ

**A:** æµ‹è¯•è„šæœ¬æœ¬èº«æ²¡é—®é¢˜ï¼Œä½†å»ºè®®ï¼š
1. ä½¿ç”¨è®­ç»ƒæ•°æ®é›†çš„ä¸€éƒ¨åˆ†è¿›è¡Œæµ‹è¯•
2. æˆ–è€…åœ¨è®­ç»ƒè¿‡ç¨‹ä¸­æ·»åŠ éªŒè¯é›†è¯„ä¼°
3. è¿™æ ·å¯ä»¥æ›´å‡†ç¡®åœ°ç›‘æ§è®­ç»ƒè¿›åº¦

---

## é™„å½•ï¼šå®Œæ•´çš„è®­ç»ƒç›‘æ§è„šæœ¬

```python
# monitor_training.py
import pandas as pd
import matplotlib.pyplot as plt

def analyze_training_progress(tensorboard_log_path):
    """åˆ†æè®­ç»ƒè¿›åº¦"""
    
    # è¯»å–TensorBoardæ—¥å¿—
    df = pd.read_csv(tensorboard_log_path)
    
    # ç»˜åˆ¶å…³é”®æŒ‡æ ‡
    fig, axes = plt.subplots(2, 2, figsize=(15, 10))
    
    # 1. d_accå˜åŒ–
    axes[0, 0].plot(df['step'], df['critic/d_acc'])
    axes[0, 0].axhline(y=0.5, color='r', linestyle='--', label='Random')
    axes[0, 0].set_title('Discriminator Accuracy')
    axes[0, 0].set_xlabel('Step')
    axes[0, 0].set_ylabel('Accuracy')
    axes[0, 0].legend()
    
    # 2. score_diffå˜åŒ–
    axes[0, 1].plot(df['step'], df['critic/score_diff'])
    axes[0, 1].axhline(y=0, color='r', linestyle='--', label='Equal')
    axes[0, 1].set_title('Score Difference (Teacher - Student)')
    axes[0, 1].set_xlabel('Step')
    axes[0, 1].set_ylabel('Score Diff')
    axes[0, 1].legend()
    
    # 3. åˆ†æ•°åˆ†å¸ƒ
    axes[1, 0].plot(df['step'], df['critic/teacher_score_mean'], label='Teacher')
    axes[1, 0].plot(df['step'], df['critic/student_score_mean'], label='Student')
    axes[1, 0].set_title('Score Distribution')
    axes[1, 0].set_xlabel('Step')
    axes[1, 0].set_ylabel('Score')
    axes[1, 0].legend()
    
    # 4. æ¢¯åº¦èŒƒæ•°
    axes[1, 1].plot(df['step'], df['critic/grad_norm'])
    axes[1, 1].set_title('Gradient Norm')
    axes[1, 1].set_xlabel('Step')
    axes[1, 1].set_ylabel('Grad Norm')
    
    plt.tight_layout()
    plt.savefig('training_progress.png')
    print("è®­ç»ƒè¿›åº¦å›¾å·²ä¿å­˜åˆ° training_progress.png")
    
    # æ‰“å°è¯Šæ–­ä¿¡æ¯
    print("\n=== è®­ç»ƒå¥åº·åº¦è¯Šæ–­ ===")
    
    latest = df.iloc[-1]
    print(f"å½“å‰æ­¥æ•°: {latest['step']}")
    print(f"d_acc: {latest['critic/d_acc']:.2%}")
    print(f"score_diff: {latest['critic/score_diff']:.4f}")
    print(f"grad_norm: {latest['critic/grad_norm']:.4f}")
    
    # åˆ¤æ–­è®­ç»ƒçŠ¶æ€
    if latest['critic/d_acc'] > 0.8:
        print("âš ï¸  è­¦å‘Š: d_accè¿‡é«˜ï¼ŒCriticå¯èƒ½è¿‡æ‹Ÿåˆ")
        print("   å»ºè®®: é™ä½critic_lræˆ–å¢åŠ temperature")
    elif latest['critic/d_acc'] < 0.55:
        print("âœ… è‰¯å¥½: d_accæ¥è¿‘éšæœºï¼ŒStudentè´¨é‡æ¥è¿‘Teacher")
    else:
        print("ğŸ“Š æ­£å¸¸: è®­ç»ƒè¿›è¡Œä¸­")
    
    if latest['critic/score_diff'] > 3.0:
        print("ğŸ“ˆ Studentè´¨é‡è¿˜æœ‰å¾ˆå¤§æå‡ç©ºé—´")
    elif latest['critic/score_diff'] < 1.0:
        print("âœ… Studentè´¨é‡å·²æ¥è¿‘Teacher")
    
    if latest['critic/grad_norm'] > 5.0:
        print("âš ï¸  è­¦å‘Š: æ¢¯åº¦èŒƒæ•°è¿‡å¤§ï¼Œå¯èƒ½ä¸ç¨³å®š")
    elif latest['critic/grad_norm'] < 0.1:
        print("âš ï¸  è­¦å‘Š: æ¢¯åº¦èŒƒæ•°è¿‡å°ï¼Œå­¦ä¹ å¯èƒ½åœæ»")

if __name__ == "__main__":
    analyze_training_progress("path/to/tensorboard/log.csv")
```

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# 1. å¯¼å‡ºTensorBoardæ—¥å¿—ä¸ºCSV
tensorboard --logdir=/path/to/logs --export_csv=log.csv

# 2. è¿è¡Œåˆ†æè„šæœ¬
python monitor_training.py
```
