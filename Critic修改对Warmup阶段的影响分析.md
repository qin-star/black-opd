# Critic ä¿®æ”¹å¯¹ Warm-up é˜¶æ®µçš„å½±å“åˆ†æ

## ä¿®æ”¹å†…å®¹å›é¡¾

### æ ¸å¿ƒä¿®æ”¹

**ä¿®æ”¹ä½ç½®**ï¼š`verl/verl/workers/critic/dp_critic.py`

**ä¿®æ”¹å†…å®¹**ï¼š
1. æ·»åŠ  `_compute_last_token_mask()` æ–¹æ³•
2. æ™ºèƒ½è·³è¿‡ EOS tokenï¼Œä½¿ç”¨å€’æ•°ç¬¬äºŒä¸ª token

**ä¿®æ”¹å‰**ï¼š
```python
# ç›´æ¥ä½¿ç”¨æœ€åä¸€ä¸ª token
last_token_indices = response_lengths - 1
last_token_mask[batch_indices, last_token_indices] = True
```

**ä¿®æ”¹å**ï¼š
```python
# æ£€æµ‹ EOS tokenï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡
if last_token_ids == eos_token_id:
    last_token_indices = last_token_indices - 1
last_token_mask[batch_indices, last_token_indices] = True
```

## Warm-up é˜¶æ®µåˆ†æ

### Warm-up é˜¶æ®µçš„ç›®æ ‡

```
Stage 1 (SeqKD): 
  - Actor å­¦ä¹ æ¨¡ä»¿ teacher
  - Critic ä¸å‚ä¸

Stage 2 (Warm-up/GSPO):
  - Actor å†»ç»“ï¼ˆä¸æ›´æ–°ï¼‰
  - Critic å­¦ä¹ åˆ¤åˆ« teacher å’Œ student çš„è´¨é‡å·®å¼‚
  - ç›®æ ‡ï¼šè®­ç»ƒä¸€ä¸ªå¥½çš„ Critic æ¨¡å‹

Stage 3 (GAD):
  - Actor å’Œ Critic åŒæ—¶è®­ç»ƒ
  - å¯¹æŠ—è®­ç»ƒ
```

### Warm-up é˜¶æ®µçš„è®­ç»ƒæœºåˆ¶

åœ¨ Warm-up é˜¶æ®µï¼ŒCritic çš„è®­ç»ƒæ–¹å¼ï¼š

```python
# 1. ç”Ÿæˆ student responses (ä½¿ç”¨å†»ç»“çš„ Actor)
student_responses = actor.generate(prompts)  # åŒ…å« EOS token

# 2. è·å– teacher responses (ä»æ•°æ®é›†)
teacher_responses = dataset["teacher_response"]  # ä¸åŒ…å« EOS token

# 3. Critic æ‰“åˆ†
student_scores = critic(prompts + student_responses)
teacher_scores = critic(prompts + teacher_responses)

# 4. è®¡ç®— discriminator loss
loss = -log(sigmoid(teacher_scores - student_scores))

# 5. æ›´æ–° Critic
critic.backward(loss)
```

## ä¿®æ”¹çš„å½±å“åˆ†æ

### 1. å¯¹ Warm-up é˜¶æ®µçš„å½±å“

#### å½±å“ Aï¼šè®­ç»ƒæ•°æ®çš„ä¸€è‡´æ€§

**ä¿®æ”¹å‰**ï¼š
```
Student: [token1, token2, EOS] â†’ æå– EOS çš„ value
Teacher: [token1, token2]      â†’ æå– token2 çš„ value

Critic å­¦ä¹ åˆ°çš„æ¨¡å¼ï¼š
  "EOS token çš„ value åº”è¯¥ä½äºå†…å®¹ token çš„ value"
  
è¿™æ˜¯é”™è¯¯çš„å­¦ä¹ ç›®æ ‡ï¼
```

**ä¿®æ”¹å**ï¼š
```
Student: [token1, token2, EOS] â†’ è·³è¿‡ EOSï¼Œæå– token2 çš„ value
Teacher: [token1, token2]      â†’ æå– token2 çš„ value

Critic å­¦ä¹ åˆ°çš„æ¨¡å¼ï¼š
  "ç›¸åŒä½ç½®çš„ tokenï¼Œæ ¹æ®ä¸Šä¸‹æ–‡è´¨é‡ç»™å‡ºä¸åŒçš„ value"
  
è¿™æ˜¯æ­£ç¡®çš„å­¦ä¹ ç›®æ ‡ï¼
```

**ç»“è®º**ï¼šä¿®æ”¹åçš„ Critic å­¦ä¹ åˆ°çš„æ˜¯**æ­£ç¡®çš„åˆ¤åˆ«èƒ½åŠ›**ã€‚

#### å½±å“ Bï¼šè®­ç»ƒç¨³å®šæ€§

**ä¿®æ”¹å‰**ï¼š
```
ç›¸åŒç­”æ¡ˆçš„åˆ†æ•°å·®å¼‚ï¼š7-15 åˆ†
â†’ æ¢¯åº¦ä¸ç¨³å®š
â†’ è®­ç»ƒéœ‡è¡
â†’ éš¾ä»¥æ”¶æ•›
```

**ä¿®æ”¹å**ï¼š
```
ç›¸åŒç­”æ¡ˆçš„åˆ†æ•°å·®å¼‚ï¼š< 0.1 åˆ†
â†’ æ¢¯åº¦ç¨³å®š
â†’ è®­ç»ƒå¹³æ»‘
â†’ å®¹æ˜“æ”¶æ•›
```

**ç»“è®º**ï¼šä¿®æ”¹åçš„è®­ç»ƒ**æ›´ç¨³å®š**ã€‚

#### å½±å“ Cï¼šå­¦ä¹ æ•ˆç‡

**ä¿®æ”¹å‰**ï¼š
```
Critic éœ€è¦å­¦ä¹ ä¸¤ä¸ªä»»åŠ¡ï¼š
1. åŒºåˆ† EOS vs å†…å®¹ tokenï¼ˆé”™è¯¯ä»»åŠ¡ï¼‰
2. åŒºåˆ† teacher vs student è´¨é‡ï¼ˆæ­£ç¡®ä»»åŠ¡ï¼‰

ç»“æœï¼šå­¦ä¹ æ•ˆç‡ä½ï¼Œå®¹æ˜“å­¦å
```

**ä¿®æ”¹å**ï¼š
```
Critic åªéœ€è¦å­¦ä¹ ä¸€ä¸ªä»»åŠ¡ï¼š
1. åŒºåˆ† teacher vs student è´¨é‡ï¼ˆæ­£ç¡®ä»»åŠ¡ï¼‰

ç»“æœï¼šå­¦ä¹ æ•ˆç‡é«˜ï¼Œç›®æ ‡æ˜ç¡®
```

**ç»“è®º**ï¼šä¿®æ”¹åçš„å­¦ä¹ **æ›´é«˜æ•ˆ**ã€‚

### 2. å¯¹å·²è®­ç»ƒçš„ Warm-up Critic çš„å½±å“

å¦‚æœä½ å·²ç»æœ‰ä¸€ä¸ªè®­ç»ƒå¥½çš„ Warm-up Critic æ¨¡å‹ï¼š

#### åœºæ™¯ Aï¼šä½¿ç”¨æ—§ Critic ç»§ç»­è®­ç»ƒ

```
æ—§ Critic å­¦åˆ°çš„æ¨¡å¼ï¼š
  - EOS token â†’ ä½åˆ†
  - å†…å®¹ token â†’ é«˜åˆ†
  - å¯èƒ½è¿˜æœ‰ä¸€äº›æ­£ç¡®çš„è´¨é‡åˆ¤åˆ«èƒ½åŠ›

æ–°çš„è®­ç»ƒä»£ç ï¼š
  - è·³è¿‡ EOS token
  - æå–å†…å®¹ token

ç»“æœï¼š
  âœ… æ—§ Critic çš„"å†…å®¹ token"åˆ¤åˆ«èƒ½åŠ›ä»ç„¶æœ‰æ•ˆ
  âŒ æ—§ Critic çš„"EOS token"åˆ¤åˆ«èƒ½åŠ›è¢«æµªè´¹
  âš ï¸  å¯èƒ½éœ€è¦ä¸€äº›æ­¥æ•°æ¥é€‚åº”æ–°çš„æå–æ–¹å¼
```

**å½±å“ç¨‹åº¦**ï¼šä¸­ç­‰
- ä¸ä¼šå®Œå…¨å¤±æ•ˆ
- ä½†å¯èƒ½éœ€è¦ 50-100 æ­¥æ¥é€‚åº”

#### åœºæ™¯ Bï¼šé‡æ–°è®­ç»ƒ Warm-up Critic

```
ä¼˜ç‚¹ï¼š
  âœ… ä»å¤´å­¦ä¹ æ­£ç¡®çš„åˆ¤åˆ«èƒ½åŠ›
  âœ… æ²¡æœ‰æ—§æ¨¡å¼çš„å¹²æ‰°
  âœ… è®­ç»ƒæ›´ç¨³å®šã€æ›´é«˜æ•ˆ

ç¼ºç‚¹ï¼š
  âŒ éœ€è¦é‡æ–°è®­ç»ƒï¼ˆæ—¶é—´æˆæœ¬ï¼‰
  âŒ ä¸¢å¤±äº†æ—§ Critic å¯èƒ½å­¦åˆ°çš„ä¸€äº›æœ‰ç”¨æ¨¡å¼
```

**å½±å“ç¨‹åº¦**ï¼šæœ€ä¼˜
- å®Œå…¨é€‚é…æ–°çš„è®­ç»ƒæ–¹å¼
- å­¦ä¹ åˆ°æ­£ç¡®çš„åˆ¤åˆ«èƒ½åŠ›

## æ˜¯å¦éœ€è¦é‡æ–° Warm-upï¼Ÿ

### å†³ç­–çŸ©é˜µ

| åœºæ™¯ | æ˜¯å¦é‡æ–° Warm-up | ç†ç”± |
|------|-----------------|------|
| **æ—§ Critic è®­ç»ƒæ­¥æ•° < 100** | âœ… **å¼ºçƒˆå»ºè®®** | æ—§ Critic è¿˜æ²¡å­¦åˆ°å¤šå°‘æœ‰ç”¨ä¿¡æ¯ï¼Œé‡æ–°è®­ç»ƒæˆæœ¬ä½ |
| **æ—§ Critic è®­ç»ƒæ­¥æ•° 100-500** | âš ï¸ **å»ºè®®** | æ—§ Critic å¯èƒ½å­¦åäº†ï¼Œé‡æ–°è®­ç»ƒæ”¶ç›Šå¤§ |
| **æ—§ Critic è®­ç»ƒæ­¥æ•° > 500** | âš–ï¸ **å¯é€‰** | æ—§ Critic å¯èƒ½æœ‰ä¸€äº›æœ‰ç”¨æ¨¡å¼ï¼Œå¯ä»¥å°è¯•ç»§ç»­è®­ç»ƒ |
| **æ—§ Critic d_acc < 60%** | âœ… **å¼ºçƒˆå»ºè®®** | è¯´æ˜æ—§ Critic æ²¡å­¦å¥½ï¼Œé‡æ–°è®­ç»ƒ |
| **æ—§ Critic d_acc 60-80%** | âš ï¸ **å»ºè®®** | æ—§ Critic æœ‰ä¸€å®šèƒ½åŠ›ï¼Œä½†å¯èƒ½å­¦åäº† |
| **æ—§ Critic d_acc > 80%** | âŒ **ä¸å»ºè®®** | æ—§ Critic å¯èƒ½è¿‡æ‹Ÿåˆäº†ï¼Œé‡æ–°è®­ç»ƒæ›´å¥½ |

### æ¨èæ–¹æ¡ˆ

#### æ–¹æ¡ˆ 1ï¼šé‡æ–° Warm-upï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- æœ‰å……è¶³çš„è®¡ç®—èµ„æº
- è¿½æ±‚æœ€ä½³æ€§èƒ½
- æ—§ Critic è®­ç»ƒæ­¥æ•° < 500

**æ­¥éª¤**ï¼š
```bash
# 1. ä½¿ç”¨åŸºç¡€æ¨¡å‹ï¼ˆæœªè®­ç»ƒçš„ï¼‰ä½œä¸º Critic
critic_model_path="/mnt/public_data/Qwen/Qwen3-14B"

# 2. é‡æ–°è¿è¡Œ Warm-up é˜¶æ®µ
bash scripts/train/A3b_gspo/content_merge_trainning/A3b-warmup-gspo-optimized.sh

# 3. è®­ç»ƒ 200-500 æ­¥
# 4. ä¿å­˜ Critic checkpoint
# 5. è¿›å…¥ GAD é˜¶æ®µ
```

**é¢„æœŸæ•ˆæœ**ï¼š
- Critic å­¦ä¹ åˆ°æ­£ç¡®çš„åˆ¤åˆ«èƒ½åŠ›
- è®­ç»ƒç¨³å®šï¼Œæ”¶æ•›å¿«
- ä¸º GAD é˜¶æ®µæ‰“ä¸‹è‰¯å¥½åŸºç¡€

#### æ–¹æ¡ˆ 2ï¼šç»§ç»­è®­ç»ƒï¼ˆå¯é€‰ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼š
- è®¡ç®—èµ„æºæœ‰é™
- æ—§ Critic è®­ç»ƒæ­¥æ•° > 500
- æ—§ Critic d_acc åœ¨ 60-80%

**æ­¥éª¤**ï¼š
```bash
# 1. ä½¿ç”¨æ—§çš„ Critic checkpoint
critic_model_path="/path/to/old/critic/checkpoint"

# 2. ç»§ç»­ Warm-up è®­ç»ƒ
bash scripts/train/A3b_gspo/content_merge_trainning/A3b-warmup-gspo-optimized.sh

# 3. è§‚å¯Ÿå‰ 50-100 æ­¥çš„æŒ‡æ ‡
# 4. å¦‚æœ d_acc ä¸‹é™æˆ–ä¸ç¨³å®šï¼Œè€ƒè™‘é‡æ–°è®­ç»ƒ
```

**é¢„æœŸæ•ˆæœ**ï¼š
- å‰ 50-100 æ­¥å¯èƒ½æœ‰æ³¢åŠ¨ï¼ˆé€‚åº”æœŸï¼‰
- ä¹‹ååº”è¯¥ç¨³å®šä¸‹æ¥
- æœ€ç»ˆæ€§èƒ½å¯èƒ½ç•¥ä½äºé‡æ–°è®­ç»ƒ

#### æ–¹æ¡ˆ 3ï¼šA/B æµ‹è¯•ï¼ˆæœ€ç¨³å¦¥ï¼‰

**æ­¥éª¤**ï¼š
```bash
# å®éªŒ Aï¼šé‡æ–° Warm-up
critic_A = train_from_scratch()

# å®éªŒ Bï¼šç»§ç»­è®­ç»ƒ
critic_B = continue_training(old_checkpoint)

# å¯¹æ¯”æŒ‡æ ‡
compare_metrics(critic_A, critic_B)
```

**å¯¹æ¯”æŒ‡æ ‡**ï¼š
- d_accï¼ˆåˆ¤åˆ«å‡†ç¡®ç‡ï¼‰
- score_diffï¼ˆåˆ†æ•°å·®å¼‚ï¼‰
- ç›¸åŒç­”æ¡ˆåˆ†å·®
- è®­ç»ƒç¨³å®šæ€§
- æœ€ç»ˆ GAD é˜¶æ®µçš„æ€§èƒ½

## å…·ä½“å»ºè®®

### åŸºäºä½ çš„æƒ…å†µ

æ ¹æ®ä½ çš„æè¿°ï¼š
- ä½¿ç”¨çš„æ˜¯ **Qwen3-14B åŸºç¡€æ¨¡å‹**ï¼ˆæœªç»è¿‡ warm-upï¼‰
- åˆšå¼€å§‹æµ‹è¯•æ–°çš„ä¿®å¤

**å»ºè®®**ï¼šâœ… **ç›´æ¥ä½¿ç”¨ä¿®å¤åçš„ä»£ç è¿›è¡Œ Warm-up**

**ç†ç”±**ï¼š
1. ä½ è¿˜æ²¡æœ‰è®­ç»ƒå¥½çš„ Warm-up Critic
2. å¯ä»¥ç›´æ¥ç”¨æ­£ç¡®çš„æ–¹å¼è®­ç»ƒ
3. é¿å…äº†æ—§æ¨¡å¼çš„å¹²æ‰°
4. è®­ç»ƒæ•ˆç‡æ›´é«˜

### è®­ç»ƒé…ç½®å»ºè®®

```bash
# Warm-up é˜¶æ®µé…ç½®
critic_model_path="/mnt/public_data/Qwen/Qwen3-14B"  # åŸºç¡€æ¨¡å‹
critic_lr=1e-5                                        # å­¦ä¹ ç‡
critic_warmup=200                                     # Warm-up æ­¥æ•°
total_training_steps=500                              # æ€»æ­¥æ•°

# ç›‘æ§æŒ‡æ ‡
# - d_acc åº”è¯¥åœ¨ 60-80%
# - ç›¸åŒç­”æ¡ˆåˆ†å·®åº”è¯¥ < 0.5
# - score_diff åº”è¯¥åœ¨ 1-5 ä¹‹é—´
```

### è®­ç»ƒæµç¨‹

```
Step 1: Warm-up (200-500 steps)
  â†“
  ç›®æ ‡: è®­ç»ƒ Critic åˆ¤åˆ«èƒ½åŠ›
  ç›‘æ§: d_acc, score_diff, ç›¸åŒç­”æ¡ˆåˆ†å·®
  
Step 2: ä¿å­˜ Critic checkpoint
  â†“
  ä½ç½®: /path/to/warmup_critic_checkpoint
  
Step 3: GAD é˜¶æ®µ
  â†“
  ä½¿ç”¨è®­ç»ƒå¥½çš„ Critic
  Actor å’Œ Critic åŒæ—¶è®­ç»ƒ
```

## é£é™©è¯„ä¼°

### ä¸é‡æ–° Warm-up çš„é£é™©

**é«˜é£é™©åœºæ™¯**ï¼š
- æ—§ Critic è®­ç»ƒæ­¥æ•° < 200
- æ—§ Critic d_acc < 60%
- æ—§ Critic ç›¸åŒç­”æ¡ˆåˆ†å·® > 5.0

**é£é™©**ï¼š
- Critic åˆ¤åˆ«èƒ½åŠ›å·®
- GAD é˜¶æ®µè®­ç»ƒä¸ç¨³å®š
- Actor æ”¶åˆ°é”™è¯¯çš„å¥–åŠ±ä¿¡å·
- æœ€ç»ˆæ¨¡å‹æ€§èƒ½å·®

### é‡æ–° Warm-up çš„æˆæœ¬

**æ—¶é—´æˆæœ¬**ï¼š
- Warm-up 200-500 steps
- å‡è®¾æ¯æ­¥ 30 ç§’
- æ€»æ—¶é—´ï¼š2-4 å°æ—¶

**è®¡ç®—æˆæœ¬**ï¼š
- 8 Ã— A800 GPU
- 2-4 å°æ—¶
- ç›¸å¯¹è¾ƒä½

**æ”¶ç›Š**ï¼š
- Critic åˆ¤åˆ«èƒ½åŠ›å¼º
- GAD é˜¶æ®µè®­ç»ƒç¨³å®š
- æœ€ç»ˆæ¨¡å‹æ€§èƒ½å¥½
- **æ€§ä»·æ¯”é«˜**

## æ€»ç»“

### æ ¸å¿ƒç»“è®º

**æ˜¯å¦éœ€è¦é‡æ–° Warm-upï¼Ÿ**

| æƒ…å†µ | å»ºè®® | ç†ç”± |
|------|------|------|
| **ä½ çš„æƒ…å†µï¼ˆåŸºç¡€æ¨¡å‹ï¼‰** | âœ… **ä¸éœ€è¦** | ç›´æ¥ç”¨ä¿®å¤åçš„ä»£ç è®­ç»ƒå³å¯ |
| **å·²æœ‰æ—§ Critic < 200 æ­¥** | âœ… **éœ€è¦** | æ—§ Critic æ²¡å­¦åˆ°å¤šå°‘ï¼Œé‡æ–°è®­ç»ƒ |
| **å·²æœ‰æ—§ Critic 200-500 æ­¥** | âš ï¸ **å»ºè®®** | æ—§ Critic å¯èƒ½å­¦åï¼Œé‡æ–°è®­ç»ƒæ›´å¥½ |
| **å·²æœ‰æ—§ Critic > 500 æ­¥** | âš–ï¸ **å¯é€‰** | å¯ä»¥å°è¯•ç»§ç»­ï¼Œä½†é‡æ–°è®­ç»ƒæ›´ç¨³å¦¥ |

### ä¿®æ”¹çš„å½±å“

**å¯¹ Warm-up é˜¶æ®µ**ï¼š
- âœ… è®­ç»ƒç›®æ ‡æ›´æ­£ç¡®
- âœ… è®­ç»ƒæ›´ç¨³å®š
- âœ… å­¦ä¹ æ•ˆç‡æ›´é«˜
- âœ… ä¸º GAD é˜¶æ®µæ‰“ä¸‹è‰¯å¥½åŸºç¡€

**å¯¹å·²è®­ç»ƒçš„ Critic**ï¼š
- âš ï¸ æ—§ Critic å¯èƒ½å­¦åˆ°äº†é”™è¯¯çš„æ¨¡å¼
- âš ï¸ éœ€è¦é€‚åº”æœŸï¼ˆ50-100 æ­¥ï¼‰
- âš ï¸ æœ€ç»ˆæ€§èƒ½å¯èƒ½ç•¥ä½

### æœ€ç»ˆå»ºè®®

**å¯¹äºä½ çš„æƒ…å†µ**ï¼š
1. âœ… **ç›´æ¥ä½¿ç”¨ä¿®å¤åçš„ä»£ç è¿›è¡Œ Warm-up**
2. âœ… **è®­ç»ƒ 200-500 æ­¥**
3. âœ… **ç›‘æ§å…³é”®æŒ‡æ ‡**ï¼ˆd_acc, ç›¸åŒç­”æ¡ˆåˆ†å·®ï¼‰
4. âœ… **ä¿å­˜ checkpoint**
5. âœ… **è¿›å…¥ GAD é˜¶æ®µ**

**ä¸éœ€è¦æ‹…å¿ƒé‡æ–°è®­ç»ƒçš„é—®é¢˜ï¼Œå› ä¸ºä½ è¿˜æ²¡æœ‰è®­ç»ƒå¥½çš„ Warm-up Criticï¼**

è¿™ä¸ªä¿®å¤æ˜¯**å¿…è¦ä¸”æ­£ç¡®çš„**ï¼Œä¼šè®©ä½ çš„è®­ç»ƒæ›´ç¨³å®šã€æ›´é«˜æ•ˆï¼ğŸš€
