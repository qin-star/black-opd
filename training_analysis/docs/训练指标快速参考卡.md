# GAD 训练指标快速参考卡

## 🚀 快速诊断（30秒）

### 运行分析
```bash
python analyze_tensorboard.py
```

### 查看3个关键指标
```
1. score_diff:  _____ (目标: < 0.1)
2. ranking_loss: _____ (目标: 0.65-0.72)
3. d_acc:       _____ (参考值)
```

### 快速判断
```
如果 score_diff < 0.1 且 ranking_loss ≈ 0.68:
  → ✅ 训练健康，继续！
  
如果 score_diff > 1.0 且 ranking_loss < 0.3:
  → ⚠️ 需要调整 temperature
  
如果绝对分数 > 5:
  → ⚠️ 数值漂移，增大 score_reg
```

---

## 📊 指标速查表

| 指标 | 理想值 | 可接受 | 有问题 | 说明 |
|------|--------|--------|--------|------|
| **score_diff** | < 0.1 | 0.1-0.5 | > 1.0 | 质量差距（最重要） |
| **ranking_loss** | 0.65-0.72 | 0.5-0.8 | < 0.3 或 > 0.8 | 收敛状态（最重要） |
| **teacher_value** | -2 到 2 | -5 到 5 | > 5 或 < -5 | 数值漂移检测 |
| **student_value** | -2 到 2 | -5 到 5 | > 5 或 < -5 | 数值漂移检测 |
| **d_acc** | < 0.85 | 0.85-0.95 | > 0.95 | 仅作参考 |

---

## 🔧 参数调整速查

### Temperature 调整
```python
# 文件：verl/verl/trainer/ppo/core_algos.py (Line ~1467)

何时调整：ranking_loss < 0.3 且 d_acc > 0.95
如何调整：temperature = 2.0 → 3.0 或 5.0
预期效果：ranking_loss 增大，d_acc 下降
```

### Score_reg 调整
```python
# 文件：verl/verl/trainer/ppo/core_algos.py (Line ~1472)

何时调整：绝对分数 > 5
如何调整：score_reg = 0.005 → 0.02
预期效果：分数回到 -2 到 2 范围
```

### Diff_penalty 调整
```python
# 文件：verl/verl/trainer/ppo/core_algos.py (Line ~1475)

何时调整：diff_penalty > 0.3
如何调整：阈值 1.5 → 0.5
预期效果：diff_penalty 减小
```

---

## ⚠️ 常见误区

### ❌ 错误1：只看 d_acc
```
d_acc = 97% → 立即修改代码
```
**正确做法**：先看 score_diff 和 ranking_loss

### ❌ 错误2：忽略 ranking_loss
```
ranking_loss = 0.68 → 认为有问题
```
**正确理解**：0.68 ≈ log(2) ≈ 0.693 是理想状态！

### ❌ 错误3：过度调整
```
一次性把 temperature 从 2.0 改到 10.0
```
**正确做法**：小步调整（2.0 → 3.0），观察效果

---

## 📈 健康训练的特征

```
✅ score_diff < 0.1          (质量接近)
✅ ranking_loss ≈ 0.68       (接近收敛)
✅ 绝对分数在 [-2, 2]        (无漂移)
✅ format_reward 逐渐提升    (student 进步)
⚠️ d_acc = 97%              (正常！累积效应)
```

**结论**：这是完美的训练状态！

---

## 🔍 问题训练的特征

```
❌ score_diff > 2.0          (差距过大)
❌ ranking_loss < 0.3        (区分太容易)
❌ 绝对分数 > 5              (数值漂移)
❌ format_reward 不提升      (student 没进步)
⚠️ d_acc = 97%              (需要调整)
```

**结论**：需要调整参数！

---

## 💡 关键洞察

### score_diff vs raw_score_diff
```
score_diff = 0.08 (归一化，每个 token)
raw_score_diff = 0.8 (累积，整个序列)

关系：0.8 ≈ 0.08 × 10 (序列长度)
```

### 为什么 d_acc 高但训练健康？
```
每个 token 差异很小 (0.08)
但累积 10 个 token 后 (0.8)
Teacher 总是略高于 Student
→ d_acc = 97% 是正常的！
```

### ranking_loss 的理论最优值
```
当 Teacher ≈ Student 时：
P(teacher > student) ≈ 0.5
ranking_loss = -log(0.5) = log(2) ≈ 0.693
```

---

## 📞 需要帮助？

### 详细指南
查看：`GAD训练指标分析指南.md`

### 分析工具
```bash
# 基本分析
python analyze_tensorboard.py

# 指定文件
python analyze_tensorboard.py --log-file logs/xxx

# 指定目录
python analyze_tensorboard.py --log-dir logs/

# 分析最近 100 个点
python analyze_tensorboard.py --recent 100
```

### TensorBoard
```bash
tensorboard --logdir=logs --port=6006
```

---

## ✅ 检查清单

训练前：
- [ ] 确认日志路径正确
- [ ] 记录初始参数

训练中（每 100 steps）：
- [ ] 运行 analyze_tensorboard.py
- [ ] 记录 score_diff 和 ranking_loss
- [ ] 检查 format_reward 趋势

发现异常：
- [ ] 不要立即修改
- [ ] 收集所有指标
- [ ] 使用决策树判断
- [ ] 小步调整，观察效果

---

## 🎯 记住这3点

1. **score_diff 最重要**
   - < 0.1 = 优秀
   - > 1.0 = 需要关注

2. **ranking_loss ≈ 0.68 是好事**
   - 说明接近收敛
   - 不是问题！

3. **d_acc 高不一定是坏事**
   - 要结合 score_diff 判断
   - 可能是累积效应

---

**版本**: v1.0 | **更新**: 2025-01-22
